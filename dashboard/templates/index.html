<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plantomio Dashboard</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/sidebar.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="/static/images/favicon.ico">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
    <!-- Mobile menu toggle button -->
    <button class="mobile-toggle" id="mobile-toggle">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>

    <div class="app-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="/" class="logo">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                        <line x1="8" y1="21" x2="16" y2="21"></line>
                        <line x1="12" y1="17" x2="12" y2="21"></line>
                    </svg>
                </a>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="/" class="active" title="Dashboard"><i class="fas fa-tachometer-alt"></i></a></li>
                    <li><a href="/trends" title="Trends"><i class="fas fa-chart-line"></i></a></li>
                    <li><a href="/settings" title="Settings"><i class="fas fa-cog"></i></a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <header class="main-header">
                <div class="header-content">
                    <h1>Plantomio Dashboard</h1>
                    <p class="subtitle">Plant monitoring system</p>
                </div>
                <div class="header-status">
                    <span class="status-indicator live">Live Data</span>
                    <span class="device-id">Device: <span id="device-id">plt-404cca470da0</span></span>
                    <span class="last-update">Last update: <span id="last-update">08:19:57</span></span>
                </div>
            </header>

            <div class="page-content">
                <!-- Plant Health and Tank Level Row -->
                <div class="health-tank-container">
                    <!-- Plant Health Assessment -->
                    <div class="health-content">
                        <div class="health-header">
                            <h2>Plant Health Assessment</h2>
                            <div class="health-actions">
                                <button class="btn btn-refresh">Refresh</button>
                                <button class="btn btn-actions">Actions</button>
                            </div>
                        </div>
                        <div class="health-status">
                            <div class="status-icon good">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="status-details">
                                <h3>Good Condition</h3>
                                <p>Based on sensor readings</p>
                            </div>
                        </div>
                        
                        <div class="health-metrics">
                            <div class="health-metric">
                                <label>Overall Health</label>
                                <div class="progress-container">
                                    <div class="progress-bar" style="width: 86%"></div>
                                </div>
                                <span class="progress-value">86%</span>
                            </div>
                            
                            <div class="health-metric">
                                <label>Water Quality</label>
                                <div class="progress-container">
                                    <div class="progress-bar water-quality" style="width: 62%"></div>
                                </div>
                                <span class="progress-value">62%</span>
                            </div>
                        </div>
                        
                        <div class="recommendation-box">
                            <h4>Recommendation</h4>
                            <p>Consider reducing nutrient solution concentration. TDS levels are above optimal range for this plant type.</p>
                        </div>
                    </div>
                    
                    <!-- Tank Visualization -->
                    <div class="tank-container">
                        <div class="tank-visualization">
                            <div class="tank-level" id="tank-water-level" style="height: 75%"></div>
                            <div class="alert-level-indicator">
                                <div class="alert-level-line"></div>
                            </div>
                        </div>
                        <div class="tank-info">
                            <p>Water Level: <span id="water-level-value">2.7</span>cm</p>
                            <p><span id="water-level-percent">75</span>% Capacity</p>
                            <button class="btn btn-settings" id="tank-settings-btn">
                                <i class="fas fa-sliders-h"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Sensor Parameters Grid -->
                <div class="metrics-grid">
                    <div class="metric-card temperature">
                        <div class="metric-label">Temperature</div>
                        <div class="metric-status">Ok</div>
                        <div class="metric-value" id="temperature-value">25°C</div>
                    </div>
                    
                    <div class="metric-card tds">
                        <div class="metric-label">TDS</div>
                        <div class="metric-status high">High</div>
                        <div class="metric-value" id="tds-value">59923.9 ppm</div>
                    </div>
                    
                    <div class="metric-card ph">
                        <div class="metric-label">pH</div>
                        <div class="metric-status">Ok</div>
                        <div class="metric-value" id="ph-value">6.98</div>
                    </div>
                    
                    <div class="metric-card orp">
                        <div class="metric-label">ORP</div>
                        <div class="metric-status">Ok</div>
                        <div class="metric-value" id="orp-value">296.3 mV</div>
                    </div>
                    
                    <div class="metric-card ec">
                        <div class="metric-label">EC</div>
                        <div class="metric-status high">High</div>
                        <div class="metric-value" id="ec-value">38.35 μS/cm</div>
                    </div>
                </div>
                
                <!-- Sensor Trends -->
                <div class="sensor-trends-panel">
                    <div class="panel-header">
                        <h2>Sensor Trends</h2>
                        <div class="time-controls">
                            <button class="time-btn active">24 Hours</button>
                            <button class="time-btn">Week</button>
                            <button class="time-btn">Month</button>
                        </div>
                    </div>
                    <div class="trends-container">
                        <canvas id="main-chart" class="trends-chart"></canvas>
                    </div>
                </div>
                
                <!-- System Status -->
                <div class="status-panel">
                    <div class="panel-header">
                        <h2>System Status</h2>
                    </div>
                    <div class="status-grid">
                        <div class="status-item">
                            <div class="status-label">CPU Load</div>
                            <div class="status-gauge">
                                <div class="gauge-fill" style="width: 32%"></div>
                            </div>
                            <div class="status-value">32%</div>
                        </div>
                        
                        <div class="status-item">
                            <div class="status-label">Memory</div>
                            <div class="status-gauge">
                                <div class="gauge-fill" style="width: 45%"></div>
                            </div>
                            <div class="status-value">45%</div>
                        </div>
                        
                        <div class="status-item">
                            <div class="status-label">Storage</div>
                            <div class="status-gauge">
                                <div class="gauge-fill" style="width: 18%"></div>
                            </div>
                            <div class="status-value">18%</div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions Panel (Hidden) -->
                <div class="quick-actions-panel" style="display: none;">
                    <div class="panel-header">
                        <h2>Quick Actions</h2>
                    </div>
                    <div class="actions-grid">
                        <button class="action-btn start-pump">
                            <i class="fas fa-tint"></i> Start Pump
                        </button>
                        <button class="action-btn toggle-light">
                            <i class="fas fa-lightbulb"></i> Toggle Light
                        </button>
                        <button class="action-btn reset-sensors">
                            <i class="fas fa-redo-alt"></i> Reset Sensors
                        </button>
                        <button class="action-btn settings">
                            <i class="fas fa-cog"></i> Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="settings-backdrop" id="settings-backdrop"></div>
    <div class="tank-settings-panel" id="tank-settings-panel">
        <div class="settings-header">
            <h4>Tank Calibration</h4>
            <button class="btn-close" id="tank-settings-close">×</button>
        </div>
        <div class="settings-form">
            <div class="form-group">
                <label for="min-level">Min Level (cm)</label>
                <input type="number" id="min-level" class="form-control" value="0" step="0.1">
            </div>
            <div class="form-group">
                <label for="max-level">Max Level (cm)</label>
                <input type="number" id="max-level" class="form-control" value="10" step="0.1">
            </div>
            <div class="settings-actions">
                <button class="btn btn-save" id="save-tank-settings">Save</button>
            </div>
        </div>
    </div>

    <!-- Service Status Panel -->
    <div class="service-status-panel">
        <div class="panel-header"><h2>Service Status</h2></div>
        <div class="status-grid">
            <!-- Dashboard status -->
            <div class="status-item">
                <div class="status-label">Dashboard</div>
                <div class="status-value" id="dashboard-status">--</div>
            </div>
            <!-- Node-RED status -->
            <div class="status-item">
                <div class="status-label">Node-RED</div>
                <div class="status-value" id="nodered-status">--</div>
            </div>
            <!-- VictoriaMetrics status -->
            <div class="status-item">
                <div class="status-label">VictoriaMetrics</div>
                <div class="status-value" id="vm-status">--</div>
            </div>
            <!-- MQTT status -->
            <div class="status-item">
                <div class="status-label">MQTT</div>
                <div class="status-value" id="mqtt-status">--</div>
            </div>
            <!-- AP Mode status -->
            <div class="status-item">
                <div class="status-label">AP Mode</div>
                <div class="status-value" id="ap-status">--</div>
            </div>
        </div>
    </div>

    <script src="/static/js/dashboard.js"></script>
    <script>
        // Update service status on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check service status
            fetch('/health')
                .then(response => response.json())
                .then(data => {
                    if (data.services) {
                        // Update dashboard status
                        document.getElementById('dashboard-status').textContent = 
                            data.services.dashboard?.status === 'ok' ? 'Running' : 'Error';
                        document.getElementById('dashboard-status').className = 
                            data.services.dashboard?.status === 'ok' ? 'status-ok' : 'status-error';
                        
                        // Update Node-RED status
                        document.getElementById('nodered-status').textContent = 
                            data.services.node_red?.status === 'ok' ? 'Running' : 'Error';
                        document.getElementById('nodered-status').className = 
                            data.services.node_red?.status === 'ok' ? 'status-ok' : 'status-error';
                        
                        // Update VictoriaMetrics status
                        document.getElementById('vm-status').textContent = 
                            data.services.victoria_metrics?.status === 'ok' ? 'Running' : 'Error';
                        document.getElementById('vm-status').className = 
                            data.services.victoria_metrics?.status === 'ok' ? 'status-ok' : 'status-error';
                        
                        // For MQTT and AP Mode (not in the provided API yet)
                        document.getElementById('mqtt-status').textContent = 'Unknown';
                        document.getElementById('ap-status').textContent = 'Unknown';
                    }
                })
                .catch(error => {
                    console.error('Error checking service status:', error);
                });
        });
        
        // Mobile sidebar toggle
        document.getElementById('mobile-toggle').addEventListener('click', function() {
            document.querySelector('.sidebar').classList.toggle('active');
        });

        // Tank settings modal
        document.getElementById('tank-settings-btn').addEventListener('click', function() {
            document.getElementById('tank-settings-panel').classList.add('active');
            document.getElementById('settings-backdrop').classList.add('active');
        });
        
        document.getElementById('tank-settings-close').addEventListener('click', function() {
            closeSettings();
        });
        
        document.getElementById('settings-backdrop').addEventListener('click', function() {
            closeSettings();
        });
        
        function closeSettings() {
            document.getElementById('tank-settings-panel').classList.remove('active');
            document.getElementById('settings-backdrop').classList.remove('active');
        }
        
        // Save tank settings
        document.getElementById('save-tank-settings').addEventListener('click', function() {
            const minLevel = parseFloat(document.getElementById('min-level').value) || 0;
            const maxLevel = parseFloat(document.getElementById('max-level').value) || 10;
            const currentLevel = parseFloat(document.getElementById('water-level-value').innerText);
            
            // Calculate percentage
            const percentage = Math.round(((currentLevel - minLevel) / (maxLevel - minLevel)) * 100);
            const clampedPercentage = Math.min(Math.max(percentage, 0), 100);
            
            // Update display
            document.getElementById('water-level-percent').innerText = clampedPercentage;
            document.getElementById('tank-water-level').style.height = clampedPercentage + '%';
            
            // Save to localStorage
            localStorage.setItem('tankSettings', JSON.stringify({
                min: minLevel,
                max: maxLevel
            }));
            
            closeSettings();
        });
        
        // Apply tank settings on load
        function applyTankSettings() {
            const savedSettings = localStorage.getItem('tankSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                document.getElementById('min-level').value = settings.min;
                document.getElementById('max-level').value = settings.max;
                
                const currentLevel = parseFloat(document.getElementById('water-level-value').innerText);
                const percentage = Math.round(((currentLevel - settings.min) / (settings.max - settings.min)) * 100);
                const clampedPercentage = Math.min(Math.max(percentage, 0), 100);
                
                document.getElementById('water-level-percent').innerText = clampedPercentage;
                document.getElementById('tank-water-level').style.height = clampedPercentage + '%';
            }
        }
        
        // Initialize charts
        function initChart() {
            const chartCanvas = document.getElementById('main-chart');
            if (chartCanvas) {
                const ctx = chartCanvas.getContext('2d');
                
                // Get device ID for filtering
                const deviceId = document.getElementById('device-id').textContent || 'plt-404cca470da0';
                
                // We'll fetch data via API with device filter
                fetch(`/api/trends?metrics=temperature,pH,EC&minutes=1440&device=${deviceId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === "success") {
                            const timestamps = [];
                            const temperatureData = [];
                            const phData = [];
                            const ecData = [];
                            
                            // Process temperature data with timestamp deduplication
                            if (data.data.temperature) {
                                const uniqueTimestamps = new Set();
                                data.data.temperature.forEach(point => {
                                    const [timestamp, value] = point;
                                    // Only add unique timestamps
                                    if (!uniqueTimestamps.has(timestamp)) {
                                        uniqueTimestamps.add(timestamp);
                                        const date = new Date(timestamp * 1000);
                                        timestamps.push(date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
                                        temperatureData.push(parseFloat(value));
                                    }
                                });
                            }
                            
                            // Process pH data with matching timestamps
                            if (data.data.pH) {
                                const phMap = new Map();
                                data.data.pH.forEach(point => {
                                    const [timestamp, value] = point;
                                    phMap.set(timestamp, parseFloat(value));
                                });
                                
                                // Use the timestamps from temperature data as reference
                                for (let i = 0; i < timestamps.length; i++) {
                                    const timestamp = Array.from(new Set(data.data.temperature.map(p => p[0])))[i];
                                    phData.push(phMap.get(timestamp) || null);
                                }
                            }
                            
                            // Process EC data with matching timestamps
                            if (data.data.EC) {
                                const ecMap = new Map();
                                data.data.EC.forEach(point => {
                                    const [timestamp, value] = point;
                                    ecMap.set(timestamp, parseFloat(value));
                                });
                                
                                // Use the timestamps from temperature data as reference
                                for (let i = 0; i < timestamps.length; i++) {
                                    const timestamp = Array.from(new Set(data.data.temperature.map(p => p[0])))[i];
                                    ecData.push(ecMap.get(timestamp) || null);
                                }
                            }
                            
                            // Chart configuration with three Y axes
                            new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: timestamps,
                                    datasets: [
                                        {
                                            label: 'Temperature (°C)',
                                            data: temperatureData,
                                            borderColor: '#4e73df',
                                            backgroundColor: 'rgba(78, 115, 223, 0.1)',
                                            tension: 0.4,
                                            borderWidth: 2,
                                            fill: false,
                                            yAxisID: 'y-temperature'
                                        },
                                        {
                                            label: 'pH',
                                            data: phData,
                                            borderColor: '#e74a3b',
                                            backgroundColor: 'rgba(231, 74, 59, 0.1)',
                                            tension: 0.4,
                                            borderWidth: 2,
                                            fill: false,
                                            yAxisID: 'y-ph'
                                        },
                                        {
                                            label: 'EC (μS/cm)',
                                            data: ecData,
                                            borderColor: '#36b9cc',
                                            backgroundColor: 'rgba(54, 185, 204, 0.1)',
                                            tension: 0.4,
                                            borderWidth: 2,
                                            fill: false,
                                            yAxisID: 'y-ec'
                                        }
                                    ]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: {
                                            position: 'top',
                                        },
                                        title: {
                                            display: true,
                                            text: `Device: ${deviceId}`
                                        }
                                    },
                                    scales: {
                                        'y-temperature': {
                                            type: 'linear',
                                            display: true,
                                            position: 'left',
                                            title: {
                                                display: true,
                                                text: 'Temperature (°C)'
                                            },
                                            grid: {
                                                color: 'rgba(0, 0, 0, 0.05)'
                                            }
                                        },
                                        'y-ph': {
                                            type: 'linear',
                                            display: true,
                                            position: 'right',
                                            title: {
                                                display: true,
                                                text: 'pH'
                                            },
                                            grid: {
                                                drawOnChartArea: false
                                            }
                                        },
                                        'y-ec': {
                                            type: 'linear',
                                            display: true,
                                            position: 'right',
                                            title: {
                                                display: true,
                                                text: 'EC (μS/cm)'
                                            },
                                            grid: {
                                                drawOnChartArea: false
                                            }
                                        },
                                        x: {
                                            grid: {
                                                display: false
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching chart data:', error);
                        // Fallback to empty chart
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: [],
                                datasets: []
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false
                            }
                        });
                    });
            }
        }
        
        // On page load
        document.addEventListener('DOMContentLoaded', function() {
            applyTankSettings();
            initChart();
        });
    </script>
</body>
</html>