<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plantomio Trends</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/sidebar.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="/static/images/favicon.ico">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
    <!-- Mobile menu toggle button -->
    <button class="mobile-toggle" id="mobile-toggle">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>

    <div class="app-wrapper">
        <!-- Sidebar - SAME AS DASHBOARD PAGE -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="/" class="logo">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                        <line x1="8" y1="21" x2="16" y2="21"></line>
                        <line x1="12" y1="17" x2="12" y2="21"></line>
                    </svg>
                </a>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="/" title="Dashboard"><i class="fas fa-tachometer-alt"></i></a></li>
                    <li><a href="/trends" class="active" title="Trends"><i class="fas fa-chart-line"></i></a></li>
                    <li><a href="/settings" title="Settings"><i class="fas fa-cog"></i></a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <header class="main-header">
                <div class="header-content">
                    <h1>Plantomio Trends</h1>
                    <p class="subtitle">Historical data analysis</p>
                </div>
                <div class="header-status">
                    <span class="status-indicator live">Live Data</span>
                    <span class="device-id">Device: <span id="device-id">plt-404cca470da0</span></span>
                    <span class="last-update">Last update: <span id="last-update">08:19:57</span></span>
                </div>
            </header>

            <div class="page-content">
                <!-- Time Range Selection -->
                <div class="time-range-panel">
                    <div class="panel-header">
                        <h2>Time Range</h2>
                    </div>
                    <div class="time-range-controls">
                        <div class="time-control-buttons">
                            <button class="time-btn active">24 Hours</button>
                            <button class="time-btn">Week</button>
                            <button class="time-btn">Month</button>
                            <button class="time-btn">Custom</button>
                        </div>
                        <div class="date-range-selector" style="display: none;">
                            <div class="date-input">
                                <label for="start-date">Start Date</label>
                                <input type="date" id="start-date" class="form-control">
                            </div>
                            <div class="date-input">
                                <label for="end-date">End Date</label>
                                <input type="date" id="end-date" class="form-control">
                            </div>
                            <button class="btn btn-apply">Apply</button>
                        </div>
                    </div>
                </div>
                
                <!-- Temperature Chart -->
                <div class="chart-panel">
                    <div class="panel-header">
                        <h2>Temperature</h2>
                        <div class="chart-controls">
                            <button class="btn btn-export">Export Data</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="temperature-chart"></canvas>
                    </div>
                </div>
                
                <!-- pH Chart -->
                <div class="chart-panel">
                    <div class="panel-header">
                        <h2>pH Level</h2>
                        <div class="chart-controls">
                            <button class="btn btn-export">Export Data</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="ph-chart"></canvas>
                    </div>
                </div>
                
                <!-- TDS Chart -->
                <div class="chart-panel">
                    <div class="panel-header">
                        <h2>TDS Level</h2>
                        <div class="chart-controls">
                            <button class="btn btn-export">Export Data</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="tds-chart"></canvas>
                    </div>
                </div>
                
                <!-- EC Chart -->
                <div class="chart-panel">
                    <div class="panel-header">
                        <h2>EC Level</h2>
                        <div class="chart-controls">
                            <button class="btn btn-export">Export Data</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="ec-chart"></canvas>
                    </div>
                </div>
                
                <!-- Distance Chart -->
                <div class="chart-panel">
                    <div class="panel-header">
                        <h2>Distance</h2>
                        <div class="chart-controls">
                            <button class="btn btn-export">Export Data</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="distance-chart"></canvas>
                    </div>
                </div>
                
                <!-- ORP Chart -->
                <div class="chart-panel">
                    <div class="panel-header">
                        <h2>ORP</h2>
                        <div class="chart-controls">
                            <button class="btn btn-export">Export Data</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="orp-chart"></canvas>
                    </div>
                </div>
                
                <!-- Data Export -->
                <div class="export-panel">
                    <div class="panel-header">
                        <h2>Data Export</h2>
                    </div>
                    <div class="export-options">
                        <div class="form-group">
                            <label for="export-format">Format</label>
                            <select id="export-format" class="form-control">
                                <option value="csv">CSV</option>
                                <option value="json">JSON</option>
                                <option value="excel">Excel</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="export-sensors">Sensors</label>
                            <select id="export-sensors" class="form-control">
                                <option value="all">All Sensors</option>
                                <option value="temperature">Temperature</option>
                                <option value="ph">pH</option>
                                <option value="ec">EC</option>
                                <option value="tds">TDS</option>
                                <option value="distance">Distance</option>
                                <option value="orp">ORP</option>
                            </select>
                        </div>
                        <button class="btn btn-primary">Download Data</button>
                    </div>
                </div>

                {% comment %} <!-- Service Status Panel -->
                <div class="service-status-panel">
                    <div class="panel-header"><h2>Service Status</h2></div>
                    <div class="status-grid">
                        <!-- Dashboard status -->
                        <div class="status-item">
                            <div class="status-label">Dashboard</div>
                            <div class="status-value" id="dashboard-status">--</div>
                        </div>
                        <!-- Node-RED status -->
                        <div class="status-item">
                            <div class="status-label">Node-RED</div>
                            <div class="status-value" id="nodered-status">--</div>
                        </div>
                        <!-- VictoriaMetrics status -->
                        <div class="status-item">
                            <div class="status-label">VictoriaMetrics</div>
                            <div class="status-value" id="vm-status">--</div>
                        </div>
                        <!-- MQTT status -->
                        <div class="status-item">
                            <div class="status-label">MQTT</div>
                            <div class="status-value" id="mqtt-status">--</div>
                        </div>
                        <!-- AP Mode status -->
                        <div class="status-item">
                            <div class="status-label">AP Mode</div>
                            <div class="status-value" id="ap-status">--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> {% endcomment %}

    <script src="/static/js/trends.js"></script>
    <script>
        // Mobile sidebar toggle
        document.getElementById('mobile-toggle').addEventListener('click', function() {
            document.querySelector('.sidebar').classList.toggle('active');
        });
        
        // Initialize charts
        document.addEventListener('DOMContentLoaded', function() {
            // Time period settings
            let timeMinutes = 1440; // 24 hours

            // Set active time button
            document.querySelectorAll('.time-btn').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    if (this.textContent === 'Custom') {
                        document.querySelector('.date-range-selector').style.display = 'flex';
                    } else {
                        document.querySelector('.date-range-selector').style.display = 'none';
                        
                        // Set time range based on button
                        if (this.textContent === '24 Hours') {
                            timeMinutes = 1440;
                        } else if (this.textContent === 'Week') {
                            timeMinutes = 10080;
                        } else if (this.textContent === 'Month') {
                            timeMinutes = 43200;
                        }
                        
                        // Refresh all charts
                        loadChartData('temperature', 'temperature-chart', timeMinutes);
                        loadChartData('pH', 'ph-chart', timeMinutes);
                        loadChartData('TDS', 'tds-chart', timeMinutes);
                        loadChartData('EC', 'ec-chart', timeMinutes);
                        loadChartData('distance', 'distance-chart', timeMinutes);
                        loadChartData('ORP', 'orp-chart', timeMinutes);
                    }
                });
            });

            // Update service status
            updateServiceStatus();
            
            // Helper function to load chart data
            function loadChartData(metric, chartId, minutes) {
                const canvas = document.getElementById(chartId);
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                
                // Get current device ID for filtering
                const deviceId = document.getElementById('device-id').textContent || 'plt-404cca470da0';
                
                // Show loading indicator
                canvas.style.opacity = '0.5';
                
                // Fetch data from API with device ID filter
                fetch(`/api/query?metric=${metric}&minutes=${minutes}&device=${deviceId}`)
                    .then(response => response.json())
                    .then(data => {
                        // Remove loading indicator
                        canvas.style.opacity = '1';
                        
                        // Process data
                        const timestamps = [];
                        const values = [];
                        
                        if (data.data && data.data.result && data.data.result.length > 0) {
                            // Get device ID from result - corrected to use deviceID instead of device
                            const resultDeviceId = data.data.result[0].metric?.device || deviceId;
                            
                            // Extract values and filter unique timestamps
                            const uniqueTimestamps = new Set();
                            data.data.result[0].values.forEach(point => {
                                const [timestamp, value] = point;
                                // Skip NaN values
                                if (value === "NaN" || value === "nan") return;
                                
                                if (!uniqueTimestamps.has(timestamp)) {
                                    uniqueTimestamps.add(timestamp);
                                    const date = new Date(timestamp * 1000);
                                    timestamps.push(date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
                                    values.push(parseFloat(value));
                                }
                            });
                            
                            // Get chart color based on metric
                            let borderColor, backgroundColor;
                            switch (metric) {
                                case 'temperature':
                                    borderColor = '#4e73df';
                                    backgroundColor = 'rgba(78, 115, 223, 0.1)';
                                    break;
                                case 'pH':
                                    borderColor = '#e74a3b';
                                    backgroundColor = 'rgba(231, 74, 59, 0.1)';
                                    break;
                                case 'TDS':
                                    borderColor = '#1cc88a';
                                    backgroundColor = 'rgba(28, 200, 138, 0.1)';
                                    break;
                                case 'EC':
                                    borderColor = '#36b9cc';
                                    backgroundColor = 'rgba(54, 185, 204, 0.1)';
                                    break;
                                case 'distance':
                                    borderColor = '#f6c23e';
                                    backgroundColor = 'rgba(246, 194, 62, 0.1)';
                                    break;
                                case 'ORP':
                                    borderColor = '#6f42c1';
                                    backgroundColor = 'rgba(111, 66, 193, 0.1)';
                                    break;
                                default:
                                    borderColor = '#858796';
                                    backgroundColor = 'rgba(133, 135, 150, 0.1)';
                            }
                            
                            // Unit for display
                            let unit = '';
                            switch (metric) {
                                case 'temperature': unit = '°C'; break;
                                case 'pH': unit = ''; break;
                                case 'TDS': unit = 'ppm'; break;
                                case 'EC': unit = 'μS/cm'; break;
                                case 'distance': unit = 'm'; break;
                                case 'ORP': unit = 'mV'; break;
                            }
                            
                            // Destroy previous chart if it exists
                            if (window.charts && window.charts[chartId]) {
                                window.charts[chartId].destroy();
                            }
                            
                            // Create chart
                            window.charts = window.charts || {};
                            window.charts[chartId] = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: timestamps,
                                    datasets: [
                                        {
                                            label: `${metric} ${unit}`,
                                            data: values,
                                            borderColor: borderColor,
                                            backgroundColor: backgroundColor,
                                            tension: 0.4,
                                            borderWidth: 2,
                                            fill: true
                                        }
                                    ]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: {
                                            position: 'top',
                                        },
                                        title: {
                                            display: true,
                                            text: `Device: ${resultDeviceId}`
                                        },
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    let label = context.dataset.label || '';
                                                    if (label) {
                                                        label += ': ';
                                                    }
                                                    if (context.parsed.y !== null) {
                                                        label += context.parsed.y.toFixed(2);
                                                    }
                                                    return label;
                                                }
                                            }
                                        }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: false,
                                            grid: {
                                                color: 'rgba(0, 0, 0, 0.05)'
                                            }
                                        },
                                        x: {
                                            grid: {
                                                display: false
                                            }
                                        }
                                    }
                                }
                            });
                        } else {
                            // No data
                            // Destroy previous chart if it exists
                            if (window.charts && window.charts[chartId]) {
                                window.charts[chartId].destroy();
                            }
                            
                            window.charts = window.charts || {};
                            window.charts[chartId] = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: [],
                                    datasets: [{
                                        label: metric,
                                        data: [],
                                        borderColor: '#858796',
                                        backgroundColor: 'rgba(133, 135, 150, 0.1)'
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        title: {
                                            display: true,
                                            text: `No data available for device: ${deviceId}`
                                        }
                                    }
                                }
                            });
                        }
                    })
                    .catch(error => {
                        // Remove loading indicator
                        canvas.style.opacity = '1';
                        
                        console.error(`Error loading ${metric} chart:`, error);
                        // Display error chart
                        // Destroy previous chart if it exists
                        if (window.charts && window.charts[chartId]) {
                            window.charts[chartId].destroy();
                        }
                        
                        window.charts = window.charts || {};
                        window.charts[chartId] = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: [],
                                datasets: []
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: `Error loading data for device: ${deviceId}`
                                    }
                                }
                            }
                        });
                    });
            }
            
            // Initialize all charts
            loadChartData('temperature', 'temperature-chart', timeMinutes);
            loadChartData('pH', 'ph-chart', timeMinutes);
            loadChartData('TDS', 'tds-chart', timeMinutes);
            loadChartData('EC', 'ec-chart', timeMinutes);
            loadChartData('distance', 'distance-chart', timeMinutes);
            loadChartData('ORP', 'orp-chart', timeMinutes);
        });
        
        // Update service status
        function updateServiceStatus() {
            fetch('/health')
                .then(response => response.json())
                .then(data => {
                    if (data.services) {
                        // Update dashboard status
                        document.getElementById('dashboard-status').textContent = 
                            data.services.dashboard?.status === 'ok' ? 'Running' : 'Error';
                        document.getElementById('dashboard-status').className = 
                            data.services.dashboard?.status === 'ok' ? 'status-ok' : 'status-error';
                        
                        // Update Node-RED status
                        document.getElementById('nodered-status').textContent = 
                            data.services.node_red?.status === 'ok' ? 'Running' : 'Error';
                        document.getElementById('nodered-status').className = 
                            data.services.node_red?.status === 'ok' ? 'status-ok' : 'status-error';
                        
                        // Update VictoriaMetrics status
                        document.getElementById('vm-status').textContent = 
                            data.services.victoria_metrics?.status === 'ok' ? 'Running' : 'Error';
                        document.getElementById('vm-status').className = 
                            data.services.victoria_metrics?.status === 'ok' ? 'status-ok' : 'status-error';
                        
                        // Update MQTT status
                        document.getElementById('mqtt-status').textContent = 
                            data.services.mqtt?.status === 'ok' ? 'Running' : 'Error';
                        document.getElementById('mqtt-status').className = 
                            data.services.mqtt?.status === 'ok' ? 'status-ok' : 'status-error';
                        
                        // Update AP Mode status
                        document.getElementById('ap-status').textContent = 
                            data.services.ap_mode?.status === 'ok' ? 'Enabled' : 
                            data.services.ap_mode?.status === 'inactive' ? 'Disabled' : 'Unknown';
                        document.getElementById('ap-status').className = 
                            data.services.ap_mode?.status === 'ok' ? 'status-ok' : 
                            data.services.ap_mode?.status === 'inactive' ? '' : 'status-error';
                    }
                })
                .catch(error => {
                    console.error('Error checking service status:', error);
                });
        }
    </script>
</body>
</html>